import os
import logging
import json
import base64
import subprocess
from io import BytesIO
from datetime import datetime
import zipfile
import asyncio
import anthropic
import requests
from dotenv import load_dotenv
import telebot
from telebot import types
from telebot.async_telebot import AsyncTeleBot

# –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
class ScriptValidator:
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∫–ª–∞—Å—Å–∞ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤"""
    
    def __init__(self):
        self.required_code_blocks = {
            "ps1": {
                "error_handling": r"try|catch",
                "admin_check": r"if\s*\(\s*\-not\s*\(\s*\[bool\]\s*\(\s*\[System\.Security\.Principal\.WindowsIdentity\]::GetCurrent\(\)\.Groups\s*\-match\s*['\"]S-1-5-32-544['\"]\s*\)\s*\)\s*\)"
            },
            "bat": {
                "admin_check": r"NET FILE"
            }
        }
    
    def validate_scripts(self, files):
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤"""
        logger.info("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤")
        return {name: [] for name in files}
    
    def repair_common_issues(self, files):
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º"""
        logger.info("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö")
        return files
    
    def enhance_scripts(self, files):
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤"""
        logger.info("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤")
        return files

class ScriptMetrics:
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∫–ª–∞—Å—Å–∞ –º–µ—Ç—Ä–∏–∫ —Å–∫—Ä–∏–ø—Ç–æ–≤"""
    
    def __init__(self):
        pass
    
    def record_script_generation(self, data):
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ –º–µ—Ç—Ä–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤"""
        logger.info(f"–ó–∞–ø–∏—Å—å –º–µ—Ç—Ä–∏–∫ —Å–∫—Ä–∏–ø—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞): {data['timestamp']}")
        return True
    
    def get_summary(self):
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–¥–∫–∏ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º"""
        return {"total_scripts": 0, "total_errors": 0}
    
    def get_common_errors(self, limit=10):
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫"""
        return []

class PromptOptimizer:
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤"""
    
    def __init__(self, base_prompts_file="base_prompts.json"):
        pass
    
    def get_optimized_prompts(self):
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤"""
        return {
            "OPTIMIZATION_PROMPT_TEMPLATE": OPTIMIZATION_PROMPT_TEMPLATE,
            "ERROR_FIX_PROMPT_TEMPLATE": ERROR_FIX_PROMPT_TEMPLATE,
            "version": 1
        }
    
    def update_prompts_based_on_metrics(self):
        """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫"""
        logger.info("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞)")
        return False

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
TELEGRAM_TOKEN = os.getenv('TELEGRAM_TOKEN')
ANTHROPIC_API_KEY = os.getenv('ANTHROPIC_API_KEY')

# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
bot = telebot.TeleBot(TELEGRAM_TOKEN)

# –°–ª–æ–≤–∞—Ä–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_states = {}  # –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_files = {}   # –•—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_messages = {}  # –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –æ—à–∏–±–∫–∞–º
script_gen_count = 0
error_stats = {
    "total_errors": 0,
    "ps_syntax": 0,
    "bat_syntax": 0,
    "file_access": 0,
    "security": 0,
    "missing_blocks": 0,
    "other": 0
}

# –®–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã
OPTIMIZATION_PROMPT_TEMPLATE = r"""
–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—é Windows –∏ PowerShell. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Windows –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –°–ö–†–ò–ü–¢–ê–ú:
1. –°–æ–∑–¥–∞–π –¥–≤–∞ —Ñ–∞–π–ª–∞: –æ—Å–Ω–æ–≤–Ω–æ–π PowerShell —Å–∫—Ä–∏–ø—Ç (WindowsOptimizer.ps1) –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π BAT-—Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ (Start-Optimizer.bat).
2. –í BAT-—Ñ–∞–π–ª–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—Å–∫ PowerShell —Å–∫—Ä–∏–ø—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º -ExecutionPolicy Bypass –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
3. PowerShell —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å:
   - –§—É–Ω–∫—Ü–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
   - –ü—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Å–ª—É–∂–± –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
   - –û—á–∏—Å—Ç–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –¥–∏—Å–∫–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –∏—Ö –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏
   - –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (–≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ try-catch –±–ª–æ–∫–∞—Ö)
   - –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ –≤—ã–ø–æ–ª–Ω—è–µ–º—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö

–°–¢–†–£–ö–¢–£–†–ê POWERSHELL –°–ö–†–ò–ü–¢–ê:
- –í –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (Backup-Settings)
- –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –≤—ã—Ö–æ–¥–æ–º, –µ—Å–ª–∏ –ø—Ä–∞–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å —Å–∫—Ä–∏–ø—Ç–∞, –≤—ã–∑—ã–≤–∞—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è—Ö –≤ –∫–æ–Ω—Ü–µ

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
- –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–π —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏ —Å–ª—É–∂–± –ø–µ—Ä–µ–¥ –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º (Test-Path, Get-Service)
- –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞—Ä–∞–º–µ—Ç—Ä -Force –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏
- –î–æ–±–∞–≤–ª—è–π –ø–∞—Ä–∞–º–µ—Ç—Ä -ErrorAction SilentlyContinue –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–±–µ—Å–ø–µ—á—å –ø–æ–ª–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Windows 10/11
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –æ–ø–∞—Å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–ª–æ–º–∞—Ç—å —Å–∏—Å—Ç–µ–º—É (–Ω–µ –æ—Ç–∫–ª—é—á–∞–π –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–ª—É–∂–±—ã)
- –°–æ–∑–¥–∞–≤–∞–π —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –≤—Å–µ—Ö –∏–∑–º–µ–Ω—è–µ–º—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π –∫–æ–¥ –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–π —Å–∫—Ä–∏–ø—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —É—á–∏—Ç—ã–≤–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞. –ï—Å–ª–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Ç—Ä–∏ —Ñ–∞–π–ª–∞:
1. WindowsOptimizer.ps1 (–æ—Å–Ω–æ–≤–Ω–æ–π PowerShell —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
2. Start-Optimizer.bat (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π BAT-—Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞)
3. README.md (–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
"""

# –®–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫
ERROR_FIX_PROMPT_TEMPLATE = r"""
–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ PowerShell –∏ Windows. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Windows, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–Ω—ã –Ω–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.

–ó–ê–î–ê–ß–ê:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—à–∏–±–∫–∏ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ
2. –û–ø—Ä–µ–¥–µ–ª–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã
3. –°–æ–∑–¥–∞–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤

–¢–ò–ü–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´, –ö–û–¢–û–†–´–ï –ú–û–ì–£–¢ –ë–´–¢–¨ –ù–ê –°–ö–†–ò–ù–®–û–¢–ï:
1. –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ PowerShell –∏–ª–∏ BAT
2. –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
3. –ù–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∫–æ–±–∫–∏ –∏–ª–∏ –∫–∞–≤—ã—á–∫–∏
4. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
5. –û—à–∏–±–∫–∏ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ —Ñ–∞–π–ª–∞–º –∏–ª–∏ —Ä–µ–µ—Å—Ç—Ä—É
6. –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π
7. –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú –°–ö–†–ò–ü–¢–ê–ú:
- –î–æ–±–∞–≤—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö –æ—à–∏–±–æ–∫ –≤ –±—É–¥—É—â–µ–º
- –£–ª—É—á—à–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (try-catch –±–ª–æ–∫–∏)
- –î–æ–±–∞–≤—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –î–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏ –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è (Test-Path)
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
- –û–ø–µ—Ä–∞—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä -Force
- –î–ª—è PowerShell –¥–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- –î–ª—è Batch —Ñ–∞–π–ª–æ–≤ –¥–æ–±–∞–≤—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º -ExecutionPolicy Bypass

–°–¢–†–£–ö–¢–£–†–ê –°–ö–†–ò–ü–¢–û–í:
1. WindowsOptimizer.ps1 - –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
2. Start-Optimizer.bat - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫ –æ–±—Ä–∞—Ç–∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ.

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤:
1. WindowsOptimizer.ps1 (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π PowerShell —Å–∫—Ä–∏–ø—Ç)
2. Start-Optimizer.bat (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π BAT-—Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞)
"""

import re

class OptimizationBot:
    """–ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Windows"""
    
    def __init__(self, api_key, validator=None):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏"""
        self.api_key = api_key
        self.client = anthropic.Anthropic(api_key=api_key)
        self.validator = validator or ScriptValidator()
        self.metrics = ScriptMetrics()
        self.prompt_optimizer = PromptOptimizer()
        
        # –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
        self.total_scripts_generated = 0
        self.total_errors = 0
        self.error_types = {}
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
        prompts = self.prompt_optimizer.get_optimized_prompts()
        self.optimization_prompt = prompts.get("OPTIMIZATION_PROMPT_TEMPLATE", OPTIMIZATION_PROMPT_TEMPLATE)
        self.error_fix_prompt = prompts.get("ERROR_FIX_PROMPT_TEMPLATE", ERROR_FIX_PROMPT_TEMPLATE)
    
    async def generate_new_script(self, message):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã"""
        global script_gen_count
        
        try:
            logger.info(f"–ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.chat.id}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ
            if not message.photo:
                return "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."
            
            # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª —Ñ–æ—Ç–æ
            file_id = message.photo[-1].file_id
            file_info = bot.get_file(file_id)
            file_url = f"https://api.telegram.org/file/bot{TELEGRAM_TOKEN}/{file_info.file_path}"
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            img_data = requests.get(file_url).content
            
            # –ö–æ–¥–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
            img_base64 = base64.b64encode(img_data).decode('utf-8')
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è API
            user_message = user_messages.get(message.chat.id, "–°–æ–∑–¥–∞–π —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Windows")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç, –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
            prompt = self.optimization_prompt
            
            messages = [
                {
                    "role": "user", 
                    "content": [
                        {"type": "text", "text": prompt + "\n\n" + user_message},
                        {"type": "image", "source": {"type": "base64", "media_type": "image/jpeg", "data": img_base64}}
                    ]
                }
            ]
            
            logger.info("–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ Claude API...")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Claude
            response = await asyncio.to_thread(
                self.client.messages.create,
                model="claude-3-opus-20240229",
                max_tokens=4000,
                messages=messages
            )
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            response_text = response.content[0].text
            
            logger.info(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Claude API, –¥–ª–∏–Ω–∞: {len(response_text)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞
            files = self.extract_files(response_text)
            
            if not files:
                logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ñ–∞–π–ª—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞ API")
                return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ."
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤
            validation_results = self.validator.validate_scripts(files)
            
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
            error_count = 0
            for filename, issues in validation_results.items():
                error_count += len(issues)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—à–∏–±–æ–∫
            self.update_error_stats(validation_results)
            
            # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
            if error_count > 0:
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ {error_count} –æ—à–∏–±–æ–∫, –ø—Ä–∏–º–µ–Ω—è—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
                files = self.validator.repair_common_issues(files)
                
                # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
                validation_results = self.validator.validate_scripts(files)
                
                # –°–Ω–æ–≤–∞ —Å—á–∏—Ç–∞–µ–º –æ—à–∏–±–∫–∏
                fixed_error_count = 0
                for filename, issues in validation_results.items():
                    fixed_error_count += len(issues)
                
                logger.info(f"–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Å—Ç–∞–ª–æ—Å—å {fixed_error_count} –æ—à–∏–±–æ–∫")
            
            # –£–ª—É—á—à–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã (–¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç.–¥.)
            files = self.validator.enhance_scripts(files)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
            script_gen_count += 1
            self.total_scripts_generated += 1
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            self.metrics.record_script_generation({
                "timestamp": datetime.now().isoformat(),
                "errors": validation_results,
                "error_count": error_count,
                "fixed_count": error_count - fixed_error_count if 'fixed_error_count' in locals() else 0,
                "model": "claude-3-opus-20240229"
            })
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            user_files[message.chat.id] = files
            
            return files
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞: {e}", exc_info=True)
            return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞: {str(e)}"
    
    def extract_files(self, response_text):
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞ Claude"""
        files = {}
        
        try:
            # –ò—â–µ–º –±–ª–æ–∫–∏ —Å —Ñ–∞–π–ª–∞–º–∏
            file_pattern = r"```(\w+)\s+(.+?)\s+filename:\s+(.+?)\s+([\s\S]+?)```"
            matches = [(ext, desc, name, content) for ext, desc, name, content in re.findall(file_pattern, response_text)]
            
            if not matches:
                # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
                file_pattern = r"```(\w+)\s+(.+?)\s*\n([\s\S]+?)```"
                alternative_matches = re.findall(file_pattern, response_text)
                
                for ext, desc, content in alternative_matches:
                    if ext.lower() in ["powershell", "ps1", "batch", "bat", "cmd", "markdown", "md"]:
                        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
                        if ext.lower() in ["powershell", "ps1"]:
                            filename = "WindowsOptimizer.ps1"
                        elif ext.lower() in ["batch", "bat", "cmd"]:
                            filename = "Start-Optimizer.bat"
                        elif ext.lower() in ["markdown", "md"]:
                            filename = "README.md"
                        else:
                            filename = f"file.{ext}"
                        
                        files[filename] = content
            else:
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
                for ext, desc, name, content in matches:
                    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                    if not name or name.strip() == "":
                        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
                        if ext.lower() in ["powershell", "ps1"]:
                            name = "WindowsOptimizer.ps1"
                        elif ext.lower() in ["batch", "bat", "cmd"]:
                            name = "Start-Optimizer.bat"
                        elif ext.lower() in ["markdown", "md"]:
                            name = "README.md"
                        else:
                            name = f"file.{ext}"
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    if not name.endswith(f".{ext}") and ext.lower() in ["ps1", "bat", "md"]:
                        name = f"{name}.{ext}"
                    
                    files[name] = content
            
            logger.info(f"–ò–∑–≤–ª–µ—á–µ–Ω–æ {len(files)} —Ñ–∞–π–ª–æ–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞")
            return files
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤: {e}", exc_info=True)
            return {}
    
    async def send_script_files_to_user(self, chat_id, files):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –≤–∏–¥–µ –∞—Ä—Ö–∏–≤–∞"""
        try:
            if not files:
                bot.send_message(chat_id, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª—ã —Å–∫—Ä–∏–ø—Ç–æ–≤.")
                return False
            
            # –°–æ–∑–¥–∞–µ–º ZIP-–∞—Ä—Ö–∏–≤ –≤ –ø–∞–º—è—Ç–∏
            zip_buffer = BytesIO()
            with zipfile.ZipFile(zip_buffer, "w", zipfile.ZIP_DEFLATED) as zip_file:
                for filename, content in files.items():
                    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –≤ –∞—Ä—Ö–∏–≤ (—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π)
                    zip_file.writestr(filename, content)
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –∞—Ä—Ö–∏–≤
                instructions = """# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–∫—Ä–∏–ø—Ç–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ –∞—Ä—Ö–∏–≤–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–∞–ø–∫—É –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ.
2. –î–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª Start-Optimizer.bat –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—è–≤—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏.

## –í–∞–∂–Ω–æ:
- –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–æ–∑–¥–∞–π—Ç–µ —Ç–æ—á–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã.
- –°–∫—Ä–∏–ø—Ç—ã —Å–æ–∑–¥–∞—é—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –ø–∞–ø–∫–µ WindowsOptimizer_Backups.
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥-—Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ WindowsOptimizer_Logs.

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏."""
                
                zip_file.writestr("–ö–ê–ö_–ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨.txt", instructions)
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –±—É—Ñ–µ—Ä–∞ –Ω–∞ –Ω–∞—á–∞–ª–æ
            zip_buffer.seek(0)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—Ä—Ö–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            bot.send_document(
                chat_id=chat_id,
                document=zip_buffer,
                caption="‚úÖ –°–∫—Ä–∏–ø—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã! –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ Start-Optimizer.bat –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.",
                visible_file_name="WindowsOptimizer.zip"
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
            bot.send_message(
                chat_id=chat_id,
                text="üìù *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:*\n\n"
                     "1. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ –∞—Ä—Ö–∏–≤–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–∞–ø–∫—É\n"
                     "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª Start-Optimizer.bat –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
                     "3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞\n\n"
                     "‚ÑπÔ∏è –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –æ—à–∏–±–∫–æ–π.",
                parse_mode="Markdown"
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_states[chat_id] = "main_menu"
            
            return True
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}", exc_info=True)
            bot.send_message(
                chat_id=chat_id, 
                text=f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–æ–≤: {str(e)}"
            )
            return False

    async def fix_script_errors(self, message):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º –ø–æ—Å–ª–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫"""
        try:
            logger.info(f"–ù–∞—á–∏–Ω–∞—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ —Å–∫—Ä–∏–ø—Ç–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.chat.id}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ
            if not message.photo:
                return "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—à–∏–±–∫–∏."
            
            # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª —Ñ–æ—Ç–æ
            file_id = message.photo[-1].file_id
            file_info = bot.get_file(file_id)
            file_url = f"https://api.telegram.org/file/bot{TELEGRAM_TOKEN}/{file_info.file_path}"
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            img_data = requests.get(file_url).content
            
            # –ö–æ–¥–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
            img_base64 = base64.b64encode(img_data).decode('utf-8')
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è API
            user_message = user_messages.get(message.chat.id, "–ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ, –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ")
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫
            prompt = self.error_fix_prompt
            
            messages = [
                {
                    "role": "user", 
                    "content": [
                        {"type": "text", "text": prompt + "\n\n" + user_message},
                        {"type": "image", "source": {"type": "base64", "media_type": "image/jpeg", "data": img_base64}}
                    ]
                }
            ]
            
            logger.info("–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ Claude API –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫...")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Claude
            response = await asyncio.to_thread(
                self.client.messages.create,
                model="claude-3-opus-20240229",
                max_tokens=4000,
                messages=messages
            )
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
            response_text = response.content[0].text
            
            logger.info(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç Claude API, –¥–ª–∏–Ω–∞: {len(response_text)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞
            files = self.extract_files(response_text)
            
            if not files:
                logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞ API")
                return "–ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–∞—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ."
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤
            validation_results = self.validator.validate_scripts(files)
            
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
            error_count = 0
            for filename, issues in validation_results.items():
                error_count += len(issues)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—à–∏–±–æ–∫
            self.update_error_stats(validation_results)
            
            # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å –æ—à–∏–±–∫–∏, –ø—ã—Ç–∞–µ–º—Å—è –∏—Ö –∏—Å–ø—Ä–∞–≤–∏—Ç—å
            if error_count > 0:
                logger.info(f"–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API–æ–º –æ—Å—Ç–∞–ª–æ—Å—å {error_count} –æ—à–∏–±–æ–∫, –ø—Ä–∏–º–µ–Ω—è—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è")
                files = self.validator.repair_common_issues(files)
                
                # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
                validation_results = self.validator.validate_scripts(files)
                
                # –°–Ω–æ–≤–∞ —Å—á–∏—Ç–∞–µ–º –æ—à–∏–±–∫–∏
                fixed_error_count = 0
                for filename, issues in validation_results.items():
                    fixed_error_count += len(issues)
                
                logger.info(f"–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Å—Ç–∞–ª–æ—Å—å {fixed_error_count} –æ—à–∏–±–æ–∫")
            
            # –£–ª—É—á—à–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã (–¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç.–¥.)
            files = self.validator.enhance_scripts(files)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
            script_gen_count += 1
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            self.metrics.record_script_generation({
                "timestamp": datetime.now().isoformat(),
                "errors": validation_results,
                "error_count": error_count,
                "fixed_count": error_count - fixed_error_count if 'fixed_error_count' in locals() else 0,
                "model": "claude-3-opus-20240229",
                "is_error_fix": True
            })
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            user_files[message.chat.id] = files
            
            return files
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞: {e}", exc_info=True)
            return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞: {str(e)}"
    
    def update_error_stats(self, validation_results):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—à–∏–±–æ–∫ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤"""
        global error_stats
        
        error_count = 0
        for filename, issues in validation_results.items():
            for issue in issues:
                error_count += 1
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
                if "PowerShell" in issue and any(syntax in issue for syntax in ["—Å–∏–Ω—Ç–∞–∫—Å–∏—Å", "—Å–∫–æ–±–∫–∏", "–Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ"]):
                    error_stats["ps_syntax"] += 1
                    self.error_types.setdefault("ps_syntax", 0)
                    self.error_types["ps_syntax"] += 1
                    
                elif "Batch" in issue and "—Å–∏–Ω—Ç–∞–∫—Å–∏—Å" in issue:
                    error_stats["bat_syntax"] += 1
                    self.error_types.setdefault("bat_syntax", 0)
                    self.error_types["bat_syntax"] += 1
                    
                elif any(access in issue for access in ["—Ñ–∞–π–ª", "–¥–æ—Å—Ç—É–ø", "Test-Path"]):
                    error_stats["file_access"] += 1
                    self.error_types.setdefault("file_access", 0)
                    self.error_types["file_access"] += 1
                    
                elif any(security in issue for security in ["–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å", "–ø—Ä–∞–≤–∞"]):
                    error_stats["security"] += 1
                    self.error_types.setdefault("security", 0)
                    self.error_types["security"] += 1
                    
                elif "–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –±–ª–æ–∫" in issue:
                    error_stats["missing_blocks"] += 1
                    self.error_types.setdefault("missing_blocks", 0)
                    self.error_types["missing_blocks"] += 1
                    
                else:
                    error_stats["other"] += 1
                    self.error_types.setdefault("other", 0)
                    self.error_types["other"] += 1
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        error_stats["total_errors"] += error_count
        self.total_errors += error_count 

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start'])
def cmd_start(message):
    """–ù–∞—á–∞–ª–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–æ—Ç–æ–º"""
    try:
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_states[message.chat.id] = "main_menu"
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=1)
        btn1 = types.KeyboardButton("üîß –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏")
        btn2 = types.KeyboardButton("üî® –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ")
        markup.add(btn1, btn2)
        
        # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        bot.send_message(
            message.chat.id,
            f"üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!\n\n"
            "–Ø –±–æ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Windows.\n\n"
            "–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?",
            reply_markup=markup
        )
        
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.chat.id} –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–æ–º–∞–Ω–¥—ã /start: {e}")
        bot.send_message(message.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@bot.message_handler(func=lambda message: user_states.get(message.chat.id) == "main_menu")
def handle_user_choice(message):
    try:
        if "—Å–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç" in message.text.lower():
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–æ–∑–¥–∞–Ω–∏—é —Å–∫—Ä–∏–ø—Ç–∞
            user_states[message.chat.id] = "waiting_for_screenshot"
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
            user_messages[message.chat.id] = "–°–æ–∑–¥–∞–π —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Windows –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞"
            
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç
            bot.send_message(
                message.chat.id,
                "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è '–°–≤–µ–¥–µ–Ω–∏—è –æ —Å–∏—Å—Ç–µ–º–µ' –∏–ª–∏ '–î–∏—Å–ø–µ—Ç—á–µ—Ä –∑–∞–¥–∞—á').",
                reply_markup=types.ReplyKeyboardRemove()
            )
            
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.chat.id} –≤—ã–±—Ä–∞–ª —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏")
            
        elif "–∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏" in message.text.lower():
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –æ—à–∏–±–æ–∫
            user_states[message.chat.id] = "waiting_for_error_screenshot"
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
            user_messages[message.chat.id] = "–ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ, –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –Ω–∞ —ç—Ç–æ–º —Å–∫—Ä–∏–Ω—à–æ—Ç–µ"
            
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –æ—à–∏–±–∫–æ–π
            bot.send_message(
                message.chat.id,
                "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –æ—à–∏–±–∫–æ–π, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å.",
                reply_markup=types.ReplyKeyboardRemove()
            )
            
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.chat.id} –≤—ã–±—Ä–∞–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ —Å–∫—Ä–∏–ø—Ç–µ")
            
        else:
            bot.send_message(
                message.chat.id,
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ.",
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
        bot.send_message(message.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
@bot.message_handler(commands=['help'])
def cmd_help(message):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"""
    try:
        help_text = """
üìö *–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Windows*

*–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:*
1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "üîß –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏"
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å–æ —Å–≤–µ–¥–µ–Ω–∏—è–º–∏ –æ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
4. –°–∫–∞—á–∞–π—Ç–µ ZIP-–∞—Ä—Ö–∏–≤ —Å –≥–æ—Ç–æ–≤—ã–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏
5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Start-Optimizer.bat –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

*–î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –≤ —Å–∫—Ä–∏–ø—Ç–µ:*
1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "üî® –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ"
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –æ—à–∏–±–∫–æ–π
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤
4. –°–∫–∞—á–∞–π—Ç–µ ZIP-–∞—Ä—Ö–∏–≤ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏

*–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
/stats - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å–∫—Ä–∏–ø—Ç–∞–º
/update_prompts - –æ–±–Ω–æ–≤–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –ø—Ä–æ–º–ø—Ç–æ–≤
/cancel - –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é

*–í–∞–∂–Ω–æ:* –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã.
"""
        bot.send_message(message.chat.id, help_text, parse_mode="Markdown")
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.chat.id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å–ø—Ä–∞–≤–∫—É")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–æ–º–∞–Ω–¥—ã /help: {e}")
        bot.send_message(message.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–ø—Ä–∞–≤–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /cancel
@bot.message_handler(commands=['cancel'])
def cmd_cancel(message):
    """–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏"""
    try:
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_states[message.chat.id] = "main_menu"
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=1)
        btn1 = types.KeyboardButton("üîß –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏")
        btn2 = types.KeyboardButton("üî® –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ")
        markup.add(btn1, btn2)
        
        bot.send_message(
            message.chat.id,
            "‚ùå –¢–µ–∫—É—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å:",
            reply_markup=markup
        )
        
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.chat.id} –æ—Ç–º–µ–Ω–∏–ª —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–æ–º–∞–Ω–¥—ã /cancel: {e}")
        bot.send_message(message.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –æ–ø–µ—Ä–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏
@bot.message_handler(content_types=['photo'], func=lambda message: user_states.get(message.chat.id) == "waiting_for_error_screenshot")
def process_error_photo(message):
    """–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ —Å–∫—Ä–∏–ø—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –æ—à–∏–±–∫–∏"""
    try:
        # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –Ω–∞—á–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É
        processing_msg = bot.send_message(
            message.chat.id,
            "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –æ—à–∏–±–∫—É –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ...",
            reply_markup=types.ReplyKeyboardRemove()
        )
        
        # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
        optimization_bot = OptimizationBot(ANTHROPIC_API_KEY)
        
        # –í—ã–∑—ã–≤–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —á–µ—Ä–µ–∑ asyncio.run
        result = asyncio.run(optimization_bot.fix_script_errors(message))
        
        if isinstance(result, dict) and len(result) > 0:
            # –°–æ–æ–±—â–∞–µ–º –æ–± —É—Å–ø–µ—à–Ω–æ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
            try:
                bot.edit_message_text(
                    "‚úÖ –û—à–∏–±–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã! –°–æ–∑–¥–∞—é ZIP-–∞—Ä—Ö–∏–≤ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏...",
                    message.chat.id,
                    processing_msg.message_id
                )
            except telebot.apihelper.ApiTelegramException as api_error:
                if "message can't be edited" in str(api_error):
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ")
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    bot.send_message(
                        message.chat.id,
                        "‚úÖ –û—à–∏–±–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã! –°–æ–∑–¥–∞—é ZIP-–∞—Ä—Ö–∏–≤ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏..."
                    )
                else:
                    raise
            except Exception as edit_error:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {edit_error}")
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                bot.send_message(
                    message.chat.id,
                    "‚úÖ –û—à–∏–±–∫–∏ —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã! –°–æ–∑–¥–∞—é ZIP-–∞—Ä—Ö–∏–≤ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —Å–∫—Ä–∏–ø—Ç–∞–º–∏..."
                )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            asyncio.run(optimization_bot.send_script_files_to_user(message.chat.id, result))
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=1)
            btn1 = types.KeyboardButton("üîß –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏")
            btn2 = types.KeyboardButton("üî® –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ")
            markup.add(btn1, btn2)
            
            bot.send_message(
                message.chat.id,
                "–ß—Ç–æ –µ—â–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?",
                reply_markup=markup
            )
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            user_states[message.chat.id] = "main_menu"
            
        else:
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            try:
                bot.edit_message_text(
                    f"‚ùå {result}",
                    message.chat.id,
                    processing_msg.message_id
                )
            except telebot.apihelper.ApiTelegramException as api_error:
                if "message can't be edited" in str(api_error):
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ")
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    bot.send_message(
                        message.chat.id,
                        f"‚ùå {result}"
                    )
                else:
                    raise
            except Exception as edit_error:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {edit_error}")
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                bot.send_message(
                    message.chat.id,
                    f"‚ùå {result}"
                )
            
            # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            bot.send_message(
                message.chat.id,
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–π —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –æ—à–∏–±–∫–æ–π –∏–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /cancel."
            )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Ñ–æ—Ç–æ —Å –æ—à–∏–±–∫–æ–π: {e}", exc_info=True)
        bot.send_message(
            message.chat.id,
            f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–π —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /cancel."
        )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
@bot.message_handler(content_types=['photo'], func=lambda message: user_states.get(message.chat.id) == "waiting_for_screenshot")
def process_photo(message):
    try:
        # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –Ω–∞—á–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É
        processing_msg = bot.send_message(
            message.chat.id,
            "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å–∫—Ä–∏–Ω—à–æ—Ç –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é —Å–∫—Ä–∏–ø—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏...",
            reply_markup=types.ReplyKeyboardRemove()
        )
        
        # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
        optimization_bot = OptimizationBot(ANTHROPIC_API_KEY)
        
        # –í—ã–∑—ã–≤–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —á–µ—Ä–µ–∑ asyncio.run
        result = asyncio.run(optimization_bot.generate_new_script(message))
        
        if isinstance(result, dict) and len(result) > 0:
            # –°–æ–æ–±—â–∞–µ–º –æ–± —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            try:
                bot.edit_message_text(
                    "‚úÖ –°–∫—Ä–∏–ø—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã! –°–æ–∑–¥–∞—é ZIP-–∞—Ä—Ö–∏–≤ —Å —Ñ–∞–π–ª–∞–º–∏...",
                    message.chat.id,
                    processing_msg.message_id
                )
            except telebot.apihelper.ApiTelegramException as api_error:
                if "message can't be edited" in str(api_error):
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ")
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    bot.send_message(
                        message.chat.id,
                        "‚úÖ –°–∫—Ä–∏–ø—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã! –°–æ–∑–¥–∞—é ZIP-–∞—Ä—Ö–∏–≤ —Å —Ñ–∞–π–ª–∞–º–∏..."
                    )
                else:
                    raise
            except Exception as edit_error:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {edit_error}")
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                bot.send_message(
                    message.chat.id,
                    "‚úÖ –°–∫—Ä–∏–ø—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã! –°–æ–∑–¥–∞—é ZIP-–∞—Ä—Ö–∏–≤ —Å —Ñ–∞–π–ª–∞–º–∏..."
                )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            asyncio.run(optimization_bot.send_script_files_to_user(message.chat.id, result))
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=1)
            btn1 = types.KeyboardButton("üîß –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏")
            btn2 = types.KeyboardButton("üî® –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–∫—Ä–∏–ø—Ç–µ")
            markup.add(btn1, btn2)
            
            bot.send_message(
                message.chat.id,
                "–ß—Ç–æ –µ—â–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?",
                reply_markup=markup
            )
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            user_states[message.chat.id] = "main_menu"
            
        else:
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            try:
                bot.edit_message_text(
                    f"‚ùå {result}",
                    message.chat.id,
                    processing_msg.message_id
                )
            except telebot.apihelper.ApiTelegramException as api_error:
                if "message can't be edited" in str(api_error):
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ")
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    bot.send_message(
                        message.chat.id,
                        f"‚ùå {result}"
                    )
                else:
                    raise
            except Exception as edit_error:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {edit_error}")
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                bot.send_message(
                    message.chat.id,
                    f"‚ùå {result}"
                )
            
            # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            bot.send_message(
                message.chat.id,
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–π —Å–∫—Ä–∏–Ω—à–æ—Ç —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /cancel."
            )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Ñ–æ—Ç–æ: {e}", exc_info=True)
        bot.send_message(
            message.chat.id,
            f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–π —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /cancel."
        )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥—Ä—É–≥–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö
@bot.message_handler(func=lambda message: user_states.get(message.chat.id) in ["waiting_for_screenshot", "waiting_for_error_screenshot"])
def handle_text_in_photo_states(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        user_messages[message.chat.id] = message.text
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        state = user_states.get(message.chat.id)
        
        if state == "waiting_for_screenshot":
            bot.send_message(
                message.chat.id,
                "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ.\n\n"
                "–í–∞—à–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞."
            )
        elif state == "waiting_for_error_screenshot":
            bot.send_message(
                message.chat.id,
                "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –æ—à–∏–±–∫–æ–π, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å.\n\n"
                "–í–∞—à–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞."
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")
        bot.send_message(message.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stats
@bot.message_handler(commands=['stats'])
def cmd_stats(message):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–∫—Ä–∏–ø—Ç–∞–º"""
    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        stats_text = "üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤*\n\n"
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        stats_text += f"–í—Å–µ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–≤: *{script_gen_count}*\n"
        stats_text += f"–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ: *{error_stats['total_errors']}*\n\n"
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —á–∞—Å—Ç–æ—Ç–µ)
        stats_text += "*–¢–∏–ø—ã –æ—à–∏–±–æ–∫:*\n"
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
        error_types_sorted = sorted(
            [
                ("–°–∏–Ω—Ç–∞–∫—Å–∏—Å PowerShell", error_stats["ps_syntax"]),
                ("–°–∏–Ω—Ç–∞–∫—Å–∏—Å Batch", error_stats["bat_syntax"]),
                ("–î–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º", error_stats["file_access"]),
                ("–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å", error_stats["security"]),
                ("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –±–ª–æ–∫–∏", error_stats["missing_blocks"]),
                ("–î—Ä—É–≥–∏–µ", error_stats["other"])
            ],
            key=lambda x: x[1],
            reverse=True
        )
        
        # –í—ã–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        for error_type, count in error_types_sorted:
            if count > 0:
                stats_text += f"- {error_type}: *{count}*\n"
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ PowerShell vs Batch
        ps_errors = error_stats["ps_syntax"] + error_stats["file_access"] + error_stats["security"]
        bat_errors = error_stats["bat_syntax"]
        
        if ps_errors > 0 or bat_errors > 0:
            stats_text += f"\n*–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫:*\n"
            stats_text += f"- PowerShell: *{ps_errors}* –æ—à–∏–±–æ–∫\n"
            stats_text += f"- Batch: *{bat_errors}* –æ—à–∏–±–æ–∫\n"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        bot.send_message(message.chat.id, stats_text, parse_mode="Markdown")
        
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.chat.id} –∑–∞–ø—Ä–æ—Å–∏–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–æ–º–∞–Ω–¥—ã /stats: {e}")
        bot.send_message(message.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤
@bot.message_handler(commands=['update_prompts'])
def cmd_update_prompts(message):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤"""
    try:
        # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
        optimizer = PromptOptimizer()
        
        # –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã
        updated = optimizer.update_prompts_based_on_metrics()
        
        if updated:
            bot.send_message(
                message.chat.id,
                "‚úÖ –ü—Ä–æ–º–ø—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
            )
        else:
            bot.send_message(
                message.chat.id,
                "‚ÑπÔ∏è –ü—Ä–æ–º–ø—Ç—ã –Ω–µ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏."
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤: {e}")
        bot.send_message(
            message.chat.id,
            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤: {str(e)}"
        )

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    try:
        logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
        prompt_optimizer = PromptOptimizer()
        
        # –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        updated = prompt_optimizer.update_prompts_based_on_metrics()
        if updated:
            logger.info("–ü—Ä–æ–º–ø—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
        else:
            logger.info("–ü—Ä–æ–º–ø—Ç—ã –Ω–µ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã")
            
        # –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ª–æ–≥–æ–≤
        logger.info("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–∫—Ä–∏–ø—Ç–∞–º:")
        logger.info(f"–í—Å–µ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–≤: {script_gen_count}")
        
        total_errors = error_stats["total_errors"]
        logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ—à–∏–±–æ–∫: {total_errors}")
        
        # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        bot.infinity_polling()
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")

if __name__ == "__main__":
    main() 