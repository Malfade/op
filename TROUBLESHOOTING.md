# Руководство по устранению неполадок

## Проблемы с API Anthropic

### Ошибки совместимости версий

Библиотека Anthropic несколько раз меняла свой API, что привело к несовместимостям между разными версиями. В нашем проекте могут возникнуть две основные ошибки:

1. **'Anthropic' object has no attribute 'messages'**
   - **Причина**: Код использует новый API (messages), но установлена старая версия библиотеки
   - **Решение**: Установить новую версию библиотеки (anthropic==0.19.0)

2. **'Anthropic' object has no attribute 'completion'**
   - **Причина**: Код использует старый API (completion), но установлена новая версия библиотеки
   - **Решение**: Установить новую версию библиотеки (anthropic==0.19.0) и убедиться, что в коде используется метод messages.create

### ВАЖНО: В текущей версии проекта используется новый API (messages.create)

В текущей версии проекта используется библиотека **anthropic версии 0.19.0** и вызовы API через метод **messages.create**. Убедитесь, что в файле requirements.txt этот выбор отражен корректно, и библиотека установлена:

```bash
pip install anthropic==0.19.0
```

### Проверка совместимости API

Для проверки совместимости API запустите скрипт:
```bash
python check_anthropic.py
```

Скрипт выведет информацию о текущей версии библиотеки, доступных методах API и рекомендуемых действиях.

### Ручное исправление при использовании неправильной версии библиотеки

Если вы видите ошибку 'Anthropic' object has no attribute 'messages', это означает, что установлена старая версия библиотеки. Выполните следующие шаги:

1. Установите версию 0.19.0:
   ```bash
   pip install anthropic==0.19.0
   ```

2. Проверьте установленную версию:
   ```bash
   pip show anthropic
   ```

3. Запустите скрипт проверки API:
   ```bash
   python check_anthropic.py
   ```

4. Убедитесь, что в файле `requirements.txt` указана версия 0.19.0 и закомментирована строка с версией 0.5.0.

5. Перезапустите бота:
   ```bash
   python optimization_bot.py
   ```

### Диагностика ошибок

| Ошибка | Возможная причина | Решение |
|--------|-------------------|---------|
| 'Anthropic' object has no attribute 'messages' | Установлена старая версия библиотеки | Установите anthropic==0.19.0 |
| 'Anthropic' object has no attribute 'completion' | Код использует устаревший метод API | Обновите код для использования messages.create |
| Access denied | Неправильный API ключ | Проверьте ANTHROPIC_API_KEY в файле .env |
| Connection error | Проблемы с сетью | Проверьте подключение к интернету и настройки файрвола |

### Проверка ANTHROPIC_API_KEY

API ключ должен быть указан в файле `.env` в следующем формате:

```
ANTHROPIC_API_KEY=sk-ant-api03-...
```

Чтобы проверить, правильно ли считывается ключ, выполните:

```python
from dotenv import load_dotenv
import os

load_dotenv()
api_key = os.getenv('ANTHROPIC_API_KEY')
print(f"API ключ: {api_key[:10]}...")  # Показываем только начало ключа для безопасности
```

### Переключение на старый API (не рекомендуется)

Если по какой-то причине вам необходимо использовать старый API (completion), нужно внести существенные изменения в код:

1. Установите старую версию библиотеки:
   ```bash
   pip install anthropic==0.5.0
   ```

2. Обновите файл requirements.txt, закомментировав строку с версией 0.19.0 и раскомментировав строку с версией 0.5.0.

3. Измените все вызовы API в коде `optimization_bot.py`, заменив messages.create на completion.

Этот подход не рекомендуется, так как старый API может быть устаревшим и перестать работать в будущем.

## Проблемы при развертывании на Railway

### Приложение не запускается

1. **Ошибки переменных окружения**:
   - Проверьте, что все необходимые переменные окружения добавлены в настройки проекта на Railway
   - Убедитесь, что формат переменных окружения соответствует требуемому (без лишних пробелов, кавычек и т.д.)

2. **Ошибки в логах Railway**:
   - Проверьте логи через интерфейс Railway или с помощью команды `railway logs`
   - Обратите внимание на сообщения об ошибках при запуске бота

3. **Проблемы с зависимостями**:
   - Убедитесь, что все необходимые зависимости указаны в `requirements.txt` с корректными версиями
   - Если в логах видны ошибки установки зависимостей, попробуйте обновить версии в `requirements.txt`

### Бот запускается, но не отвечает

1. **Проблемы с Telegram API**:
   - Проверьте, что токен бота введен правильно
   - Убедитесь, что бот не заблокирован Telegram (отправьте сообщение боту через интерфейс Telegram)

2. **Проблемы с Anthropic API**:
   - Проверьте, что ключ API Anthropic введен правильно
   - Убедитесь, что на счету Anthropic достаточно средств

3. **Ошибки сетевого подключения**:
   - Railway может иногда испытывать проблемы с подключением к внешним API
   - Попробуйте перезапустить бота через интерфейс Railway

### Как перезапустить бота на Railway

1. Через веб-интерфейс:
   - Зайдите в проект на Railway
   - Найдите сервис бота
   - Нажмите кнопку "Redeploy"

2. Через CLI:
   ```bash
   railway service restart
   ``` 